<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Signer示例</title>
    <style>
      body {
        max-width: 500px;
        margin: 40px auto;
        text-align: center;
      }
      button {
        background-color: #f6851b;
        color: white;
        border: none;
        padding: 10px;
        border-radius: 6px;
        cursor: pointer;
        margin: 10px;
      }
    </style>
  </head>
  <body>
    <h1>Signer demo</h1>
    <div>
      <button onclick="getInfo()">获取信息</button>
      <button class="send-btn" onclick="sendTransaction()">发送交易</button>
      <p class="info"></p>
    </div>
    <!-- 引入 ethers.js 库 -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.15.0/ethers.umd.min.js"
      integrity="sha512-UXYETj+vXKSURF1UlgVRLzWRS9ZiQTv3lcL4rbeLyqTXCPNZC6PTLF/Ik3uxm2Zo+E109cUpJPZfLxJsCgKSng=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>

    <script>
      async function getInfo() {
        const provider = new ethers.BrowserProvider(window.ethereum);

        await window.ethereum.request({
          method: "eth_requestAccounts",
        });

        // 获取 signer
        const signer = await provider.getSigner();
        // 通过signer获取地址和交易计数
        const addr = await signer.getAddress();
        const nonce = await signer.getNonce();
        const infoP = document.querySelector(".info");
        infoP.innerHTML = `地址: ${addr}<br>交易计数: ${nonce}`;
      }

      async function sendTransaction() {
        const btn = document.querySelector(".send-btn");
        btn.disabled = true;
        btn.textContent = "发送中...";
        try {
          const provider = new ethers.BrowserProvider(window.ethereum);
          await window.ethereum.request({
            method: "eth_requestAccounts",
          });

          const signer = await provider.getSigner();
          const tx = await signer.sendTransaction({
            to: "0x817c6ef5f2ef3cc56ce87942bf7ed74138ec284c",
            value: ethers.parseEther("0.1"),
          });
          console.log("交易已发送", tx.hash);
          await tx.wait();
          console.log("交易已确认");
          btn.textContent = "发送交易";
          btn.disabled = false;
        } catch (error) {
          console.error("发送交易时出错: ", error);
          btn.textContent = "发送交易";
          btn.disabled = false;
        }
      }

      document.addEventListener("DOMContentLoaded", async () => {
        if (typeof window.ethereum !== "undefined") {
        } else {
          alert("请安装 MetaMask!");
        }
      });
    </script>
  </body>
</html>
